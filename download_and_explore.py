"""
ä¸‹è½½å¹¶æ¢ç´¢å…¥å¢ƒå¤„æ¯æ—¥è¿‡å¢ƒæ—…å®¢ç»Ÿè®¡æ•°æ®
ç›®çš„ï¼šäº†è§£æ•°æ®ç‰¹ç‚¹ï¼Œä¸ºé€‰æ‹©åˆ†ææ–¹å‘æä¾›ä¾æ®
"""
import requests
import pandas as pd
from io import StringIO
import os

# ä¸‹è½½æ•°æ®
print("="*90)
print("ğŸ“¥ ä¸‹è½½å…¥å¢ƒå¤„æ¯æ—¥è¿‡å¢ƒæ—…å®¢ç»Ÿè®¡æ•°æ®")
print("="*90)

url = 'https://www.immd.gov.hk/opendata/eng/transport/immigration_clearance/statistics_on_daily_passenger_traffic.csv'
response = requests.get(url, timeout=60)

# ä¿å­˜åŸå§‹CSV
save_path = r"c:\Users\Lenovo\Desktop\HKU MDASC\1. Sem1\8003\project\data"
os.makedirs(save_path, exist_ok=True)

csv_path = os.path.join(save_path, "immd_daily_passenger_traffic.csv")
with open(csv_path, 'wb') as f:
    f.write(response.content)
print(f"âœ… åŸå§‹æ•°æ®å·²ä¿å­˜åˆ°: {csv_path}")

# è¯»å–å¹¶æ¸…ç†æ•°æ®
df = pd.read_csv(StringIO(response.text))
df.columns = ['Date', 'Control_Point', 'Direction', 'HK_Residents', 'Mainland_Visitors', 
              'Other_Visitors', 'Total', 'Control_Point_CN']
df['Date'] = pd.to_datetime(df['Date'], format='%d-%m-%Y')
df = df.sort_values('Date')

print(f"\nğŸ“Š æ•°æ®æ¦‚è§ˆ:")
print(f"   æ€»è®°å½•æ•°: {len(df):,}")
print(f"   æ—¥æœŸèŒƒå›´: {df['Date'].min().strftime('%Y-%m-%d')} è‡³ {df['Date'].max().strftime('%Y-%m-%d')}")
print(f"   å”¯ä¸€æ—¥æœŸæ•°: {df['Date'].nunique()}")

# ==========================================
# åˆ†æå„ç»´åº¦çš„æ•°æ®ç‰¹ç‚¹
# ==========================================
print("\n" + "="*90)
print("ğŸ” å„ç»´åº¦æ•°æ®åˆ†æ")
print("="*90)

# 1. å£å²¸åˆ†æ
print("\nğŸ“ å£å²¸ (Control Point) åˆ†æ:")
cp_stats = df.groupby('Control_Point').agg({
    'Total': ['sum', 'mean', 'std'],
    'Date': ['min', 'max', 'nunique']
}).round(0)
cp_stats.columns = ['æ€»å®¢æµ', 'æ—¥å‡å®¢æµ', 'æ ‡å‡†å·®', 'èµ·å§‹æ—¥', 'ç»“æŸæ—¥', 'å¤©æ•°']
cp_stats = cp_stats.sort_values('æ€»å®¢æµ', ascending=False)
print(cp_stats.to_string())

# 2. ä¸»è¦å£å²¸çš„æ•°æ®é‡
print("\n\nğŸ“ˆ å„å£å²¸æ•°æ®å……è¶³åº¦:")
for cp in cp_stats.index[:8]:
    cp_data = df[df['Control_Point'] == cp]
    days = cp_data['Date'].nunique()
    daily_total = cp_data.groupby('Date')['Total'].sum()
    cv = daily_total.std() / daily_total.mean() * 100  # å˜å¼‚ç³»æ•°
    print(f"   {cp}: {days}å¤©, æ—¥å‡{daily_total.mean():,.0f}äºº, å˜å¼‚ç³»æ•°{cv:.1f}%")

# 3. æ–¹å‘åˆ†æ
print("\n\nğŸ”„ æ–¹å‘ (Arrival/Departure) åˆ†æ:")
dir_stats = df.groupby('Direction')['Total'].agg(['sum', 'mean']).round(0)
print(dir_stats)

# 4. æ—…å®¢ç±»å‹åˆ†æ
print("\n\nğŸ‘¥ æ—…å®¢ç±»å‹å æ¯”:")
total_by_type = df[['HK_Residents', 'Mainland_Visitors', 'Other_Visitors']].sum()
print(f"   é¦™æ¸¯å±…æ°‘: {total_by_type['HK_Residents']:,.0f} ({total_by_type['HK_Residents']/total_by_type.sum()*100:.1f}%)")
print(f"   å†…åœ°è®¿å®¢: {total_by_type['Mainland_Visitors']:,.0f} ({total_by_type['Mainland_Visitors']/total_by_type.sum()*100:.1f}%)")
print(f"   å…¶ä»–è®¿å®¢: {total_by_type['Other_Visitors']:,.0f} ({total_by_type['Other_Visitors']/total_by_type.sum()*100:.1f}%)")

# 5. æ—¶é—´ç‰¹å¾åˆ†æ
print("\n\nğŸ“… æ—¶é—´ç‰¹å¾åˆ†æ:")
daily_total = df.groupby('Date')['Total'].sum().reset_index()
daily_total['DayOfWeek'] = daily_total['Date'].dt.dayofweek
daily_total['Month'] = daily_total['Date'].dt.month
daily_total['Year'] = daily_total['Date'].dt.year

# å‘¨å†…æ¨¡å¼
print("\n   å‘¨å†…æ¨¡å¼ (0=å‘¨ä¸€, 6=å‘¨æ—¥):")
dow_stats = daily_total.groupby('DayOfWeek')['Total'].mean()
for dow, val in dow_stats.items():
    day_names = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥']
    print(f"      {day_names[dow]}: {val:,.0f}")

# æœˆåº¦æ¨¡å¼
print("\n   æœˆåº¦æ¨¡å¼:")
month_stats = daily_total.groupby('Month')['Total'].mean()
for m, val in month_stats.items():
    print(f"      {m}æœˆ: {val:,.0f}")

# å¹´åº¦è¶‹åŠ¿
print("\n   å¹´åº¦è¶‹åŠ¿:")
year_stats = daily_total.groupby('Year')['Total'].agg(['mean', 'count'])
for y, row in year_stats.iterrows():
    print(f"      {y}å¹´: æ—¥å‡{row['mean']:,.0f}äºº ({row['count']}å¤©)")

# ==========================================
# æ¨èåˆ†ææ–¹å‘
# ==========================================
print("\n" + "="*90)
print("ğŸ¯ æ¨èåˆ†ææ–¹å‘")
print("="*90)

recommendations = """
åŸºäºä»¥ä¸Šæ•°æ®åˆ†æï¼Œæˆ‘æ¨èä»¥ä¸‹å‡ ä¸ªåˆ†ææ–¹å‘:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ–¹å‘A: é¦™æ¸¯æœºåœºæ¯æ—¥æ€»å®¢æµé¢„æµ‹ (æ¨èåº¦: â­â­â­â­â­)                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ æ•°æ®: Airportå£å²¸çš„æ¯æ—¥Total (å…¥å¢ƒ+å‡ºå¢ƒåˆè®¡)                                          â”‚
â”‚ â€¢ æ ·æœ¬: 1,812å¤©                                                                         â”‚
â”‚ â€¢ ä¼˜ç‚¹: å›½é™…åŒ–ã€å—èŠ‚å‡æ—¥å½±å“æ˜æ˜¾ã€æœ‰COVIDæ¢å¤è¶‹åŠ¿ã€å˜å¼‚ç³»æ•°é€‚ä¸­                        â”‚
â”‚ â€¢ ç‰¹ç‚¹: å¼ºå‘¨å­£èŠ‚æ€§(å‘¨æœ«é«˜å³°) + å¹´å­£èŠ‚æ€§(æš‘å‡/åœ£è¯é«˜å³°) + è¶‹åŠ¿(ç–«åæ¢å¤)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ–¹å‘B: ç½—æ¹–å£å²¸æ¯æ—¥å®¢æµé¢„æµ‹ (æ¨èåº¦: â­â­â­â­)                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ æ•°æ®: Lo Wuå£å²¸çš„æ¯æ—¥Total                                                            â”‚
â”‚ â€¢ æ ·æœ¬: 1,812å¤©                                                                         â”‚
â”‚ â€¢ ä¼˜ç‚¹: å®¢æµé‡å¤§ã€æ¨¡å¼ç¨³å®šã€å·¥ä½œæ—¥vså‘¨æœ«å·®å¼‚æ˜æ˜¾                                       â”‚
â”‚ â€¢ ç‰¹ç‚¹: ä»£è¡¨æ·±æ¸¯æ—¥å¸¸é€šå…³éœ€æ±‚ï¼Œå•†åŠ¡+è´­ç‰©ä¸ºä¸»                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ–¹å‘C: é«˜é“è¥¿ä¹é¾™ç«™å†…åœ°è®¿å®¢é¢„æµ‹ (æ¨èåº¦: â­â­â­â­)                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ æ•°æ®: Express Rail Link West Kowloonçš„Mainland_Visitors (ä»…å…¥å¢ƒ)                     â”‚
â”‚ â€¢ æ ·æœ¬: 1,812å¤©                                                                         â”‚
â”‚ â€¢ ä¼˜ç‚¹: åæ˜ å†…åœ°èµ´æ¸¯æ—…æ¸¸è¶‹åŠ¿ã€æ”¿ç­–æ•æ„Ÿæ€§é«˜ã€èŠ‚å‡æ—¥æ•ˆåº”æ˜æ˜¾                            â”‚
â”‚ â€¢ ç‰¹ç‚¹: æ˜¥èŠ‚/å›½åº†/æš‘å‡é«˜å³°æ˜æ˜¾                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ–¹å‘D: å…¨æ¸¯æ¯æ—¥æ€»å®¢æµé¢„æµ‹ (æ¨èåº¦: â­â­â­)                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ æ•°æ®: æ‰€æœ‰å£å²¸æ¯æ—¥Totalæ±‡æ€»                                                           â”‚
â”‚ â€¢ æ ·æœ¬: 1,812å¤©                                                                         â”‚
â”‚ â€¢ ä¼˜ç‚¹: å®è§‚è§†è§’ã€æ•°æ®é‡æœ€å¤§                                                           â”‚
â”‚ â€¢ ç¼ºç‚¹: æ··åˆäº†ä¸åŒå£å²¸ç‰¹æ€§ï¼Œæ¨¡å¼å¯èƒ½ä¸å¤Ÿæ¸…æ™°                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€æˆ‘çš„å»ºè®®ã€‘é€‰æ‹© æ–¹å‘A: é¦™æ¸¯æœºåœºæ¯æ—¥æ€»å®¢æµ
ç†ç”±:
1. æœºåœºæ˜¯æœ€å›½é™…åŒ–çš„å£å²¸ï¼Œæ—¶é—´åºåˆ—ç‰¹å¾ä¸°å¯Œ
2. æœ‰æ˜æ˜¾çš„å‘¨å­£èŠ‚æ€§(å‘¨æœ«)ã€å¹´å­£èŠ‚æ€§(èŠ‚å‡æ—¥)ã€è¶‹åŠ¿(ç–«åæ¢å¤)
3. æ•°æ®æ•…äº‹æ€§å¼ºï¼Œå®¹æ˜“è§£é‡Šå’Œå±•ç¤º
4. é¢„æµ‹æœ‰å®é™…åº”ç”¨ä»·å€¼ï¼ˆèˆªç­è§„åˆ’ã€äººåŠ›é…ç½®ç­‰ï¼‰
"""
print(recommendations)

# ä¿å­˜æ¸…ç†åçš„æ•°æ®
clean_df = df.copy()
clean_path = os.path.join(save_path, "immd_daily_passenger_clean.csv")
clean_df.to_csv(clean_path, index=False)
print(f"\nâœ… æ¸…ç†åæ•°æ®å·²ä¿å­˜åˆ°: {clean_path}")
